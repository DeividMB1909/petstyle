<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - PetStyle</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/frontend/css/carrito.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="logo">PetStyle</h1>
            <p class="subtitle">Tu carrito de compras</p>
        </div>

        <div class="content">
            <h2 class="section-title">Mi Carrito</h2>
            
            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">üõí</div>
                <h3 class="empty-title">Tu carrito est√° vac√≠o</h3>
                <p class="empty-text">No has agregado ning√∫n producto a√∫n.<br>Explora nuestros incre√≠bles accesorios para mascotas y encuentra lo que m√°s te guste.</p>
                <a href="main.html" class="browse-btn">Explorar Productos</a>
            </div>

            <!-- Cart Items -->
            <div class="cart-items" id="cartItems">
                <!-- Cart items will be loaded here by API -->
            </div>

            <!-- Clear Cart Button -->
            <button class="clear-cart-btn" id="clearCartBtn" style="display: none;" onclick="handleClearCart()">
                üóëÔ∏è Vaciar Carrito
            </button>

            <!-- Promo Code Section -->
            <div class="promo-section" id="promoSection" style="display: none;">
                <div class="promo-title">üí∞ C√≥digo de Descuento</div>
                <div class="promo-input-group">
                    <input type="text" class="promo-input" id="promoInput" placeholder="Ingresa tu c√≥digo">
                    <button class="promo-btn" onclick="applyPromoCode()">Aplicar</button>
                </div>
            </div>

            <!-- Shipping Options -->
            <div class="shipping-options" id="shippingSection" style="display: none;">
                <h3 class="shipping-title">üöö Opciones de Env√≠o</h3>
                <div class="shipping-option selected" data-shipping="standard">
                    <input type="radio" class="shipping-radio" name="shipping" value="standard" checked>
                    <div class="shipping-info">
                        <div class="shipping-name">Env√≠o Est√°ndar</div>
                        <div class="shipping-time">5-7 d√≠as h√°biles</div>
                    </div>
                    <div class="shipping-price">Gratis</div>
                </div>
                <div class="shipping-option" data-shipping="express">
                    <input type="radio" class="shipping-radio" name="shipping" value="express">
                    <div class="shipping-info">
                        <div class="shipping-name">Env√≠o Express</div>
                        <div class="shipping-time">2-3 d√≠as h√°biles</div>
                    </div>
                    <div class="shipping-price">$5.99</div>
                </div>
                <div class="shipping-option" data-shipping="priority">
                    <input type="radio" class="shipping-radio" name="shipping" value="priority">
                    <div class="shipping-info">
                        <div class="shipping-name">Env√≠o Prioritario</div>
                        <div class="shipping-time">1-2 d√≠as h√°biles</div>
                    </div>
                    <div class="shipping-price">$12.99</div>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="payment-methods" id="paymentSection" style="display: none;">
                <h3 class="payment-title">üí≥ M√©todo de Pago</h3>
                
                <div class="payment-option selected" data-payment="card">
                    <input type="radio" class="payment-radio" name="payment" value="card" checked>
                    <div class="payment-icon">üí≥</div>
                    <div class="payment-info">
                        <div class="payment-name">Tarjeta de Cr√©dito/D√©bito</div>
                        <div class="payment-description">Visa, Mastercard, American Express</div>
                    </div>
                </div>

                <div class="card-form active" id="cardForm">
                    <div class="form-group">
                        <label class="form-label">N√∫mero de Tarjeta</label>
                        <input type="text" class="form-input" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Vencimiento</label>
                            <input type="text" class="form-input" id="cardExpiry" placeholder="MM/AA" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CVV</label>
                            <input type="text" class="form-input" id="cardCvv" placeholder="123" maxlength="4">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre del Titular</label>
                        <input type="text" class="form-input" id="cardName" placeholder="Nombre completo">
                    </div>
                </div>

                <div class="payment-option" data-payment="paypal">
                    <input type="radio" class="payment-radio" name="payment" value="paypal">
                    <div class="payment-icon">üíô</div>
                    <div class="payment-info">
                        <div class="payment-name">PayPal</div>
                        <div class="payment-description">Pago seguro con tu cuenta PayPal o tarjeta</div>
                    </div>
                </div>

                <div class="payment-form" id="paypalForm">
                    <div class="form-group">
                        <label class="form-label">Email de PayPal</label>
                        <input type="email" class="form-input" id="paypalEmail" placeholder="tu-email@ejemplo.com">
                    </div>
                    <div class="payment-note">
                        <strong>Nota:</strong> Ser√°s redirigido a PayPal para completar el pago de forma segura.
                    </div>
                </div>

                <div class="payment-option" data-payment="transfer">
                    <input type="radio" class="payment-radio" name="payment" value="transfer">
                    <div class="payment-icon">üè¶</div>
                    <div class="payment-info">
                        <div class="payment-name">Transferencia Bancaria</div>
                        <div class="payment-description">SPEI - Transferencia electr√≥nica inmediata</div>
                    </div>
                </div>

                <div class="payment-form" id="transferForm">
                    <div class="transfer-info">
                        <h4>Datos para transferencia:</h4>
                        <div class="bank-details">
                            <div class="detail-row">
                                <span class="label">Banco:</span>
                                <span class="value">BBVA M√©xico</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Cuenta:</span>
                                <span class="value">0123456789</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">CLABE:</span>
                                <span class="value">012345678901234567</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Beneficiario:</span>
                                <span class="value">PetStyle M√©xico S.A. de C.V.</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comprobante de Transferencia</label>
                        <input type="file" class="form-input" id="transferProof" accept="image/*,.pdf">
                        <div class="file-note">Sube tu comprobante de transferencia (JPG, PNG o PDF)</div>
                    </div>
                </div>

                <div class="payment-option" data-payment="oxxo">
                    <input type="radio" class="payment-radio" name="payment" value="oxxo">
                    <div class="payment-icon">üè™</div>
                    <div class="payment-info">
                        <div class="payment-name">OXXO</div>
                        <div class="payment-description">Paga en efectivo en cualquier tienda OXXO</div>
                    </div>
                </div>

                <div class="payment-form" id="oxxoForm">
                    <div class="oxxo-info">
                        <div class="oxxo-steps">
                            <h4>¬øC√≥mo pagar en OXXO?</h4>
                            <ol>
                                <li>Ac√©rcate a cualquier tienda OXXO</li>
                                <li>Proporciona el c√≥digo de barras generado</li>
                                <li>Realiza el pago en efectivo</li>
                                <li>Guarda tu comprobante de pago</li>
                            </ol>
                        </div>
                        <div class="oxxo-note">
                            <strong>Importante:</strong> El c√≥digo de barras ser√° generado despu√©s de confirmar tu pedido. Tienes 3 d√≠as para realizar el pago.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary" id="summarySection" style="display: none;">
                <h3 class="summary-title">üìã Resumen del Pedido</h3>
                <div class="summary-row">
                    <span>Subtotal (<span id="itemCount">0</span> productos)</span>
                    <span id="subtotal">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>Env√≠o</span>
                    <span id="shippingCost">Gratis</span>
                </div>
                <div class="summary-row" id="discountRow" style="display: none;">
                    <span>Descuento (<span id="discountCode"></span>)</span>
                    <span class="discount" id="discount">-$0.00</span>
                </div>
                <div class="summary-row" id="savingsRow" style="display: none;">
                    <span>¬°Ahorras!</span>
                    <span class="savings" id="savings">$0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="total">$0.00</span>
                </div>
            </div>

            <!-- Checkout Button -->
            <button class="checkout-btn" id="checkoutBtn" style="display: none;" onclick="processOrder()">
                <span id="checkoutText">üöÄ Finalizar Compra</span>
                <div class="loading" id="checkoutLoading" style="display: none;"></div>
            </button>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <a href="main.html" class="nav-item">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Inicio</div>
            </a>
            <a href="favorites.html" class="nav-item">
                <div class="nav-icon">‚ù§Ô∏è</div>
                <div class="nav-label">Favoritos</div>
            </a>
            <div class="nav-item active" style="position: relative;">
                <div class="nav-icon">üõí</div>
                <div class="nav-label">Carrito</div>
                <div class="cart-badge" id="cartBadge">0</div>
            </div>
            <a href="profile.html" class="nav-item">
                <div class="nav-icon">üë§</div>
                <div class="nav-label">Perfil</div>
            </a>
        </div>

        <!-- Order Success Modal -->
        <div class="modal-overlay" id="orderModal" style="display: none;">
            <div class="modal">
                <div class="modal-icon">üéâ</div>
                <h3 class="modal-title">¬°Pedido Realizado!</h3>
                <p class="modal-text">Tu pedido ha sido procesado exitosamente. Recibir√°s un email de confirmaci√≥n en breve.</p>
                <div class="order-number" id="orderNumber">#PET-12345</div>
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="closeModal()">Seguir Comprando</button>
                    <button class="modal-btn primary" onclick="trackOrder()">Rastrear Pedido</button>
                </div>
            </div>
        </div>

        <!-- Login Required Modal -->
        <div class="modal-overlay" id="loginModal" style="display: none;">
            <div class="modal">
                <div class="modal-icon">üîê</div>
                <h3 class="modal-title">Inicia Sesi√≥n</h3>
                <p class="modal-text">Necesitas iniciar sesi√≥n para ver tu carrito de compras.</p>
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="closeLoginModal()">Cancelar</button>
                    <button class="modal-btn primary" onclick="goToLogin()">Iniciar Sesi√≥n</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="loading-spinner"></div>
            <p id="loadingText">Cargando...</p>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <!-- SCRIPTS -->
    <!-- 1. API Connection (DEBE IR PRIMERO) -->
    <script src="/frontend/js/api.js"></script>
    
    <!-- 2. Cart specific functionality -->
    <script>
        // Variables globales para el carrito
        let currentCart = null;
        let currentUser = null;
        let isLoading = false;

        // ================================================
        // INICIALIZACI√ìN
        // ================================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üõí Iniciando p√°gina de carrito...');
            
            // Verificar si el usuario est√° logueado
            if (!isUserLoggedIn()) {
                showLoginRequired();
                return;
            }

            // Cargar carrito del usuario
            await loadUserCart();
            
            // Configurar eventos
            setupCartEvents();
            
            console.log('‚úÖ Carrito inicializado correctamente');
        });

        // ================================================
        // FUNCIONES DE CARGA DE DATOS
        // ================================================
        async function loadUserCart() {
            try {
                showLoadingOverlay('Cargando tu carrito...');
                
                const cartResponse = await getCart();
                currentCart = cartResponse.data || cartResponse;
                
                hideLoadingOverlay();
                displayCartContent();
                updateCartCounter();
                
            } catch (error) {
                hideLoadingOverlay();
                console.error('Error cargando carrito:', error);
                
                if (error.message.includes('401') || error.message.includes('403')) {
                    showLoginRequired();
                } else {
                    showToast('Error al cargar el carrito', 'error');
                }
            }
        }

        // ================================================
        // FUNCIONES DE VISUALIZACI√ìN
        // ================================================
        function displayCartContent() {
            const emptyState = document.getElementById('emptyState');
            const cartItems = document.getElementById('cartItems');
            const promoSection = document.getElementById('promoSection');
            const shippingSection = document.getElementById('shippingSection');
            const paymentSection = document.getElementById('paymentSection');
            const summarySection = document.getElementById('summarySection');
            const checkoutBtn = document.getElementById('checkoutBtn');
            const clearCartBtn = document.getElementById('clearCartBtn');

            if (!currentCart || !currentCart.items || currentCart.items.length === 0) {
                // Carrito vac√≠o
                emptyState.style.display = 'block';
                cartItems.style.display = 'none';
                promoSection.style.display = 'none';
                shippingSection.style.display = 'none';
                paymentSection.style.display = 'none';
                summarySection.style.display = 'none';
                checkoutBtn.style.display = 'none';
                clearCartBtn.style.display = 'none';
            } else {
                // Carrito con productos
                emptyState.style.display = 'none';
                cartItems.style.display = 'block';
                promoSection.style.display = 'block';
                shippingSection.style.display = 'block';
                paymentSection.style.display = 'block';
                summarySection.style.display = 'block';
                checkoutBtn.style.display = 'block';
                clearCartBtn.style.display = 'block';

                renderCartItems();
                updateSummary();
            }
        }

        function renderCartItems() {
            const container = document.getElementById('cartItems');
            
            container.innerHTML = currentCart.items.map(item => `
                <div class="cart-item-api" data-product-id="${item.product._id}">
                    <div class="item-image">
                        <img src="${getProductImage(item.product)}" 
                             alt="${item.product.name}"
                             onerror="this.src='/frontend/images/default-product.jpg'"
                             loading="lazy">
                    </div>
                    <div class="item-details">
                        <h4 class="item-name">${item.product.name}</h4>
                        <p class="item-brand">${item.product.brand || ''}</p>
                        <div class="item-price-container">
                            ${item.product.originalPrice && item.product.discount ? 
                                `<span class="original-price">$${item.product.originalPrice}</span>` : ''
                            }
                            <span class="current-price">$${item.product.price}</span>
                        </div>
                        <div class="quantity-controls">
                            <button onclick="updateItemQuantity('${item.product._id}', ${item.quantity - 1})" 
                                    class="qty-btn minus"
                                    ${item.quantity <= 1 ? 'disabled' : ''}>
                                ‚àí
                            </button>
                            <span class="quantity">${item.quantity}</span>
                            <button onclick="updateItemQuantity('${item.product._id}', ${item.quantity + 1})" 
                                    class="qty-btn plus">
                                +
                            </button>
                        </div>
                        <p class="item-subtotal">Subtotal: $${(item.product.price * item.quantity).toFixed(2)}</p>
                        ${item.product.stock <= item.product.minStock ? 
                            '<p class="stock-warning">‚ö†Ô∏è Pocas unidades disponibles</p>' : ''
                        }
                    </div>
                    <button onclick="removeCartItem('${item.product._id}')" 
                            class="remove-btn" 
                            title="Eliminar producto">
                        √ó
                    </button>
                </div>
            `).join('');
        }

        function updateSummary() {
            if (!currentCart || !currentCart.items) return;

            const itemCount = currentCart.items.reduce((sum, item) => sum + item.quantity, 0);
            const subtotal = currentCart.items.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
            
            document.getElementById('itemCount').textContent = itemCount;
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('total').textContent = `$${subtotal.toFixed(2)}`;
        }

        function updateCartCounter() {
            const badge = document.getElementById('cartBadge');
            if (currentCart && currentCart.items) {
                const totalItems = currentCart.items.reduce((sum, item) => sum + item.quantity, 0);
                badge.textContent = totalItems;
                badge.style.display = totalItems > 0 ? 'block' : 'none';
            } else {
                badge.textContent = '0';
                badge.style.display = 'none';
            }
        }

        // ================================================
        // FUNCIONES DE CARRITO
        // ================================================
        async function updateItemQuantity(productId, newQuantity) {
            if (newQuantity < 1) {
                await removeCartItem(productId);
                return;
            }

            if (isLoading) return;
            isLoading = true;

            try {
                showLoadingOverlay('Actualizando cantidad...');
                await updateQuantity(productId, newQuantity);
                await loadUserCart();
                showToast('Cantidad actualizada', 'success');
            } catch (error) {
                console.error('Error actualizando cantidad:', error);
                showToast('Error al actualizar cantidad', 'error');
            } finally {
                hideLoadingOverlay();
                isLoading = false;
            }
        }

        async function removeCartItem(productId) {
            if (isLoading) return;
            
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
                return;
            }

            isLoading = true;

            try {
                showLoadingOverlay('Eliminando producto...');
                await removeItem(productId);
                await loadUserCart();
                showToast('Producto eliminado del carrito', 'success');
            } catch (error) {
                console.error('Error eliminando producto:', error);
                showToast('Error al eliminar producto', 'error');
            } finally {
                hideLoadingOverlay();
                isLoading = false;
            }
        }

        async function handleClearCart() {
            if (!confirm('¬øEst√°s seguro de que quieres vaciar tu carrito completo?')) {
                return;
            }

            if (isLoading) return;
            isLoading = true;

            try {
                showLoadingOverlay('Vaciando carrito...');
                await clearCart();
                await loadUserCart();
                showToast('Carrito vaciado exitosamente', 'success');
            } catch (error) {
                console.error('Error vaciando carrito:', error);
                showToast('Error al vaciar carrito', 'error');
            } finally {
                hideLoadingOverlay();
                isLoading = false;
            }
        }

        // ================================================
        // FUNCIONES DE MODALES Y UI
        // ================================================
        function showLoginRequired() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function goToLogin() {
            localStorage.setItem('redirectAfterLogin', window.location.href);
            window.location.href = 'login.html';
        }

        function showLoadingOverlay(text = 'Cargando...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            overlay.style.display = 'flex';
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove despu√©s de 5 segundos
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // ================================================
        // FUNCIONES DE EVENTOS
        // ================================================
        function setupCartEvents() {
            // Configurar eventos de opciones de env√≠o
            document.querySelectorAll('.shipping-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.shipping-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input[type="radio"]').checked = true;
                    updateShippingCost();
                });
            });

            // Configurar eventos de m√©todos de pago
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input[type="radio"]').checked = true;
                    togglePaymentForms();
                });
            });

            console.log('‚úÖ Eventos del carrito configurados');
        }

        function updateShippingCost() {
            const selectedShipping = document.querySelector('.shipping-option.selected');
            const shippingCostElement = document.getElementById('shippingCost');
            
            if (selectedShipping) {
                const cost = selectedShipping.querySelector('.shipping-price').textContent;
                shippingCostElement.textContent = cost;
            }
        }

        function togglePaymentForms() {
            const selectedPayment = document.querySelector('.payment-option.selected');
            const paymentValue = selectedPayment.querySelector('input[type="radio"]').value;
            
            // Ocultar todos los formularios
            document.querySelectorAll('.payment-form').forEach(form => {
                form.classList.remove('active');
            });
            
            // Mostrar el formulario correspondiente
            const activeForm = document.getElementById(`${paymentValue}Form`);
            if (activeForm) {
                activeForm.classList.add('active');
            }
        }

        // ================================================
        // FUNCIONES PARA MANTENER COMPATIBILIDAD
        // ================================================
        function applyPromoCode() {
            const promoInput = document.getElementById('promoInput');
            const code = promoInput.value.trim();
            
            if (!code) {
                showToast('Ingresa un c√≥digo promocional', 'error');
                return;
            }

            // Placeholder para l√≥gica de c√≥digos promocionales
            showToast('C√≥digo aplicado exitosamente', 'success');
            promoInput.value = '';
        }

        function processOrder() {
            if (!currentCart || !currentCart.items || currentCart.items.length === 0) {
                showToast('Tu carrito est√° vac√≠o', 'error');
                return;
            }

            // Validar m√©todo de pago
            const selectedPayment = document.querySelector('.payment-option.selected input[type="radio"]').value;
            
            if (selectedPayment === 'card') {
                if (!validateCardForm()) return;
            } else if (selectedPayment === 'paypal') {
                if (!validatePayPalForm()) return;
            }

            // Simular procesamiento de orden
            showLoadingOverlay('Procesando tu pedido...');
            
            setTimeout(() => {
                hideLoadingOverlay();
                document.getElementById('orderModal').style.display = 'flex';
                // Vaciar carrito despu√©s de la orden
                setTimeout(() => {
                    handleClearCart();
                }, 1000);
            }, 2000);
        }

        function validateCardForm() {
            const cardNumber = document.getElementById('cardNumber').value;
            const cardExpiry = document.getElementById('cardExpiry').value;
            const cardCvv = document.getElementById('cardCvv').value;
            const cardName = document.getElementById('cardName').value;

            if (!cardNumber || !cardExpiry || !cardCvv || !cardName) {
                showToast('Completa todos los campos de la tarjeta', 'error');
                return false;
            }
            return true;
        }

        function validatePayPalForm() {
            const paypalEmail = document.getElementById('paypalEmail').value;
            
            if (!paypalEmail) {
                showToast('Ingresa tu email de PayPal', 'error');
                return false;
            }
            return true;
        }

        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
            window.location.href = 'main.html';
        }

        function trackOrder() {
            showToast('Funci√≥n de rastreo en desarrollo', 'info');
            closeModal();
        }

        // ================================================
        // HELPER FUNCTIONS
        // ================================================
        function getProductImage(product) {
            if (product.images && product.images.length > 0) {
                const primaryImage = product.images.find(img => img.isPrimary) || product.images[0];
                return primaryImage.optimizedUrl || primaryImage.url;
            }
            return '/frontend/images/default-product.jpg';
        }
    </script>

    <!-- 3. Original cart script (para funciones adicionales si las hay) -->
      <script src="../js/api.js"></script>
    <script src="/frontend/js/carrito.js"></script>
</body>
</html>
