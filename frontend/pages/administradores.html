<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetStyle - Panel de Administradores</title>
    <link rel="stylesheet" href="/frontend/css/administradores.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-user">
                <span id="adminUserName">Admin</span>
                <button class="login-btn" onclick="confirmLogout()">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>
            <h1>
                <span class="logo">üêæ</span>
                PetStyle Admin
            </h1>
            <p>Panel de administraci√≥n - Gesti√≥n de usuarios y productos</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('users')">
                <span class="icon">üë•</span>
                <span>Usuarios</span>
            </button>
            <button class="nav-tab" onclick="switchTab('products')">
                <span class="icon">üõçÔ∏è</span>
                <span>Productos</span>
            </button>
            <button class="nav-tab" onclick="switchTab('dashboard')">
                <span class="icon">üìä</span>
                <span>Dashboard</span>
            </button>
        </nav>

        <!-- Content -->
        <main class="content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="tab-section">
                <div class="section-header">
                    <h2>
                        <span class="icon">üìä</span>
                        Dashboard General
                    </h2>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        üîÑ Actualizar
                    </button>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>üìà Resumen General</h3>
                        </div>
                        <div class="card-content">
                            <div class="metric">
                                <span class="metric-value" id="dashTotalUsers">0</span>
                                <span class="metric-label">Usuarios Totales</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value" id="dashTotalProducts">0</span>
                                <span class="metric-label">Productos Totales</span>
                            </div>
                            <div class="metric">
                                <span class="metric-value" id="dashTotalOrders">0</span>
                                <span class="metric-label">Pedidos</span>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>üö® Alertas</h3>
                        </div>
                        <div class="card-content">
                            <div class="alert-list" id="alertsList">
                                <div class="alert-item">
                                    <span class="alert-icon">‚ö†Ô∏è</span>
                                    <span>Cargando alertas...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <h3>üéØ Acciones R√°pidas</h3>
                        </div>
                        <div class="card-content">
                            <button class="quick-action-btn" onclick="openModal('userModal')">
                                üë• Crear Usuario
                            </button>
                            <button class="quick-action-btn" onclick="openModal('productModal')">
                                üì¶ Crear Producto
                            </button>
                            <button class="quick-action-btn" onclick="generateReport()">
                                üìä Generar Reporte
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users" class="tab-section active">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon">üë•</div>
                        <h3 id="totalUsers">-</h3>
                        <p>Total Usuarios</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">‚úÖ</div>
                        <h3 id="activeUsers">-</h3>
                        <p>Activos</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">üÜï</div>
                        <h3 id="newUsers">-</h3>
                        <p>Nuevos</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">üõ°Ô∏è</div>
                        <h3 id="adminUsers">-</h3>
                        <p>Admins</p>
                    </div>
                </div>

                <!-- Section Header -->
                <div class="section-header">
                    <h2>
                        <span class="icon">üë•</span>
                        Gesti√≥n de Usuarios
                    </h2>
                    <button class="btn btn-primary" onclick="openModal('userModal')">
                        ‚ûï Nuevo Usuario
                    </button>
                </div>

                <!-- Search and Filters -->
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Buscar usuarios..." id="userSearch">
                    <span class="search-icon">üîç</span>
                    <select class="filter-select" id="userRoleFilter">
                        <option value="">Todos los roles</option>
                        <option value="admin">Administradores</option>
                        <option value="customer">Clientes</option>
                    </select>
                    <select class="filter-select" id="userStatusFilter">
                        <option value="">Todos los estados</option>
                        <option value="true">Activos</option>
                        <option value="false">Inactivos</option>
                    </select>
                </div>

                <!-- Users Table (Desktop) -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" class="loading-row">Cargando usuarios...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Users Cards (Mobile) -->
                <div class="cards-container" id="usersCardsContainer"></div>
            </section>

            <!-- Products Section -->
            <section id="products" class="tab-section">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon">üì¶</div>
                        <h3 id="totalProducts">-</h3>
                        <p>Total</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">‚úÖ</div>
                        <h3 id="inStockProducts">-</h3>
                        <p>En Stock</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">‚ö†Ô∏è</div>
                        <h3 id="lowStockProducts">-</h3>
                        <p>Stock Bajo</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">‚ùå</div>
                        <h3 id="outStockProducts">-</h3>
                        <p>Agotados</p>
                    </div>
                </div>

                <!-- Section Header -->
                <div class="section-header">
                    <h2>
                        <span class="icon">üõçÔ∏è</span>
                        Gesti√≥n de Productos
                    </h2>
                    <button class="btn btn-primary" onclick="openModal('productModal')">
                        ‚ûï Nuevo Producto
                    </button>
                </div>

                <!-- Search and Filters -->
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Buscar productos..." id="productSearch">
                    <span class="search-icon">üîç</span>
                    <select class="filter-select" id="productCategoryFilter">
                        <option value="">Todas las categor√≠as</option>
                        <option value="perros">Perros</option>
                        <option value="gatos">Gatos</option>
                        <option value="aves">Aves</option>
                        <option value="peces">Peces</option>
                    </select>
                    <select class="filter-select" id="productStatusFilter">
                        <option value="">Todos los estados</option>
                        <option value="true">Activos</option>
                        <option value="false">Inactivos</option>
                    </select>
                </div>

                <!-- Products Table (Desktop) -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Marca</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="8" class="loading-row">Cargando productos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Products Cards (Mobile) -->
                <div class="cards-container" id="productsCardsContainer"></div>
            </section>
        </main>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Nuevo Usuario</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label for="userName">Nombre completo</label>
                        <input type="text" id="userName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email</label>
                        <input type="email" id="userEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="userPhone">Tel√©fono</label>
                        <input type="tel" id="userPhone" class="form-control">
                    </div>
                    <div class="form-group" id="passwordGroup">
                        <label for="userPassword">Contrase√±a</label>
                        <input type="password" id="userPassword" class="form-control" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <label for="userRole">Rol</label>
                        <select id="userRole" class="form-control" required>
                            <option value="">Seleccionar rol</option>
                            <option value="admin">Administrador</option>
                            <option value="customer">Cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userIsActive">Estado</label>
                        <select id="userIsActive" class="form-control" required>
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveUser()">
                    <span id="saveUserText">Guardar</span>
                    <div class="loading-spinner" id="saveUserSpinner" style="display: none;"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="productModalTitle">Nuevo Producto</h3>
                <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-group">
                        <label for="productName">Nombre del producto</label>
                        <input type="text" id="productName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="productDescription">Descripci√≥n</label>
                        <textarea id="productDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    
                    <!-- Campo de Imagen -->
                    <div class="form-group">
                        <label for="productImage">Imagen del producto</label>
                        <div class="image-upload-container" onclick="document.getElementById('productImageInput').click()">
                            <input type="file" id="productImageInput" class="image-upload-input" accept="image/*" onchange="handleImageUpload(this)">
                            <div class="image-upload-content">
                                <div class="image-upload-icon">üì∑</div>
                                <div class="image-upload-text">Seleccionar imagen</div>
                                <div class="image-upload-subtext">Arrastra y suelta o haz clic para seleccionar<br>Formatos: JPG, PNG, WebP (M√°x. 5MB)</div>
                            </div>
                        </div>
                        <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
                            <img id="imagePreview" class="image-preview" alt="Vista previa">
                            <button type="button" class="image-remove-btn" onclick="removeImage()">&times;</button>
                            <div class="image-info" id="imageInfo"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="productCategory">Categor√≠a</label>
                        <select id="productCategory" class="form-control" required>
                            <option value="">Seleccionar categor√≠a</option>
                            <!-- Se cargar√°n din√°micamente desde la API -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productBrand">Marca</label>
                        <input type="text" id="productBrand" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="productSku">SKU</label>
                        <input type="text" id="productSku" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Precio</label>
                        <input type="number" id="productPrice" class="form-control" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productStock">Stock</label>
                        <input type="number" id="productStock" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productMinStock">Stock M√≠nimo</label>
                        <input type="number" id="productMinStock" class="form-control" min="0" value="5">
                    </div>
                    <div class="form-group">
                        <label for="productFeatured">Producto Destacado</label>
                        <select id="productFeatured" class="form-control">
                            <option value="false">No</option>
                            <option value="true">S√≠</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productIsActive">Estado</label>
                        <select id="productIsActive" class="form-control" required>
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('productModal')">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveProduct()">
                    <span id="saveProductText">Guardar</span>
                    <div class="loading-spinner" id="saveProductSpinner" style="display: none;"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirmModal" class="modal-overlay" style="display: none;">
        <div class="modal small">
            <div class="modal-header">
                <h3 class="modal-title">Confirmar Eliminaci√≥n</h3>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">¬øEst√°s seguro de que quieres eliminar este elemento?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal-overlay" style="display: none;">
        <div class="modal small">
            <div class="modal-header">
                <h3 class="modal-title">Cerrar Sesi√≥n</h3>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro de que quieres cerrar sesi√≥n?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('logoutModal')">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="performLogout()">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <!-- 1. API Connection -->
    <script src="/frontend/js/api.js"></script>
    
    <!-- 2. Admin Panel Functionality -->
    <script>
        // ================================================
        // VARIABLES GLOBALES
        // ================================================
        let allUsers = [];
        let allProducts = [];
        let allCategories = [];
        let currentEditingUser = null;
        let currentEditingProduct = null;
        let currentDeleteCallback = null;
        
        // ================================================
        // INICIALIZACI√ìN
        // ================================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üõ°Ô∏è Iniciando panel de administraci√≥n...');
            
            // Verificar autenticaci√≥n de admin
            if (!isAdminLoggedIn()) {
                console.log('‚ùå No autorizado como admin');
                showToast('Acceso denegado. Debes ser administrador.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            // Cargar datos iniciales
            await loadInitialData();
            
            // Configurar event listeners
            setupEventListeners();
            
            console.log('‚úÖ Panel de administraci√≥n inicializado');
        });

        async function loadInitialData() {
            try {
                showToast('Cargando datos...', 'info');
                
                // Cargar datos en paralelo
                await Promise.all([
                    loadUsers(),
                    loadProducts(),
                    loadCategories(),
                    updateDashboard()
                ]);
                
                showToast('Datos cargados correctamente', 'success');
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showToast('Error al cargar datos', 'error');
            }
        }

        // ================================================
        // FUNCIONES DE AUTENTICACI√ìN
        // ================================================
        function isAdminLoggedIn() {
            const token = localStorage.getItem('authToken');
            const role = localStorage.getItem('userRole');
            return token && role === 'admin';
        }

        function confirmLogout() {
            document.getElementById('logoutModal').style.display = 'flex';
        }

        function performLogout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        // ================================================
        // FUNCIONES DE NAVEGACI√ìN
        // ================================================
        function switchTab(tabName) {
            // Remover clase active de todas las tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Activar tab seleccionada
            event.target.closest('.nav-tab').classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Cargar datos si es necesario
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        // ================================================
        // FUNCIONES DE USUARIOS
        // ================================================
        async function loadUsers() {
            try {
                const response = await apiRequest('/users', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.success) {
                    allUsers = response.data || [];
                    displayUsers();
                    updateUserStats();
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                showToast('Error al cargar usuarios', 'error');
            }
        }

        function displayUsers() {
            const tableBody = document.getElementById('usersTableBody');
            const cardsContainer = document.getElementById('usersCardsContainer');
            
            if (allUsers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="no-data">No hay usuarios</td></tr>';
                cardsContainer.innerHTML = '<div class="no-data">No hay usuarios</div>';
                return;
            }

            // Tabla para desktop
            tableBody.innerHTML = allUsers.map(user => `
                <tr>
                    <td>${user._id.substring(0, 8)}...</td>
                    <td>
                        <div class="user-info">
                            <strong>${user.name}</strong>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge badge-${user.role === 'admin' ? 'danger' : 'primary'}">
                            ${user.role === 'admin' ? 'üõ°Ô∏è Admin' : 'üë§ Cliente'}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-${user.isActive ? 'success' : 'secondary'}">
                            ${user.isActive ? '‚úÖ Activo' : '‚ùå Inactivo'}
                        </span>
                    </td>
                    <td>${formatDate(user.createdAt)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editUser('${user._id}')" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user._id}', '${user.name}')" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Cards para mobile
            cardsContainer.innerHTML = allUsers.map(user => `
                <div class="user-card">
                    <div class="card-header">
                        <h4>${user.name}</h4>
                        <span class="badge badge-${user.role === 'admin' ? 'danger' : 'primary'}">
                            ${user.role === 'admin' ? 'Admin' : 'Cliente'}
                        </span>
                    </div>
                    <div class="card-body">
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Estado:</strong> 
                            <span class="badge badge-${user.isActive ? 'success' : 'secondary'}">
                                ${user.isActive ? 'Activo' : 'Inactivo'}
                            </span>
                        </p>
                        <p><strong>Registro:</strong> ${formatDate(user.createdAt)}</p>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-outline" onclick="editUser('${user._id}')">Editar</button>
                        <button class="btn btn-danger" onclick="deleteUser('${user._id}', '${user.name}')">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function updateUserStats() {
            const total = allUsers.length;
            const active = allUsers.filter(u => u.isActive).length;
            const admins = allUsers.filter(u => u.role === 'admin').length;
            const recent = allUsers.filter(u => 
                new Date(u.createdAt) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            ).length;

            document.getElementById('totalUsers').textContent = total;
            document.getElementById('activeUsers').textContent = active;
            document.getElementById('adminUsers').textContent = admins;
            document.getElementById('newUsers').textContent = recent;
        }

        async function saveUser() {
            try {
                const userData = {
                    name: document.getElementById('userName').value.trim(),
                    email: document.getElementById('userEmail').value.trim(),
                    phone: document.getElementById('userPhone').value.trim(),
                    role: document.getElementById('userRole').value,
                    isActive: document.getElementById('userIsActive').value === 'true'
                };

                const password = document.getElementById('userPassword').value;
                if (password) {
                    userData.password = password;
                }

                showSaveUserLoading(true);

                let response;
                if (currentEditingUser) {
                    // Actualizar usuario existente
                    response = await apiRequest(`/users/${currentEditingUser}`, {
                        method: 'PUT',
                        body: JSON.stringify(userData),
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                } else {
                    // Crear nuevo usuario
                    if (!password) {
                        showToast('La contrase√±a es requerida para nuevos usuarios', 'error');
                        showSaveUserLoading(false);
                        return;
                    }
                    
                    response = await apiRequest('/users', {
                        method: 'POST',
                        body: JSON.stringify(userData),
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                }

                if (response.success) {
                    showToast(currentEditingUser ? 'Usuario actualizado' : 'Usuario creado', 'success');
                    closeModal('userModal');
                    await loadUsers();
                } else {
                    throw new Error(response.message || 'Error al guardar usuario');
                }

            } catch (error) {
                console.error('Error guardando usuario:', error);
                showToast('Error al guardar usuario: ' + error.message, 'error');
            } finally {
                showSaveUserLoading(false);
            }
        }

        function editUser(userId) {
            const user = allUsers.find(u => u._id === userId);
            if (!user) return;

            currentEditingUser = userId;
            
            document.getElementById('userModalTitle').textContent = 'Editar Usuario';
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userIsActive').value = user.isActive.toString();
            
            // Ocultar campo de contrase√±a para edici√≥n
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('userPassword').required = false;
            
            openModal('userModal');
        }

        function deleteUser(userId, userName) {
            document.getElementById('confirmMessage').textContent = 
                `¬øEst√°s seguro de que quieres eliminar al usuario "${userName}"?`;
            
            currentDeleteCallback = async () => {
                try {
                    const response = await apiRequest(`/users/${userId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });

                    if (response.success) {
                        showToast('Usuario eliminado', 'success');
                        await loadUsers();
                    } else {
                        throw new Error(response.message || 'Error al eliminar usuario');
                    }
                } catch (error) {
                    console.error('Error eliminando usuario:', error);
                    showToast('Error al eliminar usuario: ' + error.message, 'error');
                }
            };
            
            openModal('confirmModal');
        }

        // ================================================
        // FUNCIONES DE PRODUCTOS
        // ================================================
        async function loadProducts() {
            try {
                const response = await apiRequest('/products?limit=100', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.success) {
                    allProducts = response.data || [];
                    displayProducts();
                    updateProductStats();
                }
            } catch (error) {
                console.error('Error cargando productos:', error);
                showToast('Error al cargar productos', 'error');
            }
        }

        async function loadCategories() {
            try {
                const response = await apiRequest('/categories', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.success) {
                    allCategories = response.data || [];
                    populateCategorySelect();
                }
            } catch (error) {
                console.error('Error cargando categor√≠as:', error);
                // Usar categor√≠as por defecto si falla
                populateCategorySelect();
            }
        }

        function populateCategorySelect() {
            const select = document.getElementById('productCategory');
            select.innerHTML = '<option value="">Seleccionar categor√≠a</option>';
            
            if (allCategories.length > 0) {
                allCategories.forEach(category => {
                    select.innerHTML += `<option value="${category._id}">${category.name}</option>`;
                });
            } else {
                // Categor√≠as por defecto
                const defaultCategories = [
                    { name: 'Perros', value: 'perros' },
                    { name: 'Gatos', value: 'gatos' },
                    { name: 'Aves', value: 'aves' },
                    { name: 'Peces', value: 'peces' }
                ];
                
                defaultCategories.forEach(category => {
                    select.innerHTML += `<option value="${category.value}">${category.name}</option>`;
                });
            }
        }

        function displayProducts() {
            const tableBody = document.getElementById('productsTableBody');
            const cardsContainer = document.getElementById('productsCardsContainer');
            
            if (allProducts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="no-data">No hay productos</td></tr>';
                cardsContainer.innerHTML = '<div class="no-data">No hay productos</div>';
                return;
            }

            // Tabla para desktop
            tableBody.innerHTML = allProducts.map(product => `
                <tr>
                    <td>${product.sku}</td>
                    <td>
                        <div class="product-info">
                            <strong>${product.name}</strong>
                            <br>
                            <small>${product.description.substring(0, 50)}...</small>
                        </div>
                    </td>
                    <td>${getCategoryName(product.category)}</td>
                    <td>${product.brand || '-'}</td>
                    <td>${product.price}</td>
                    <td>
                        <span class="stock-indicator ${getStockClass(product)}">
                            ${product.stock}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-${product.isActive ? 'success' : 'secondary'}">
                            ${product.isActive ? '‚úÖ Activo' : '‚ùå Inactivo'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editProduct('${product._id}')" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product._id}', '${product.name}')" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Cards para mobile
            cardsContainer.innerHTML = allProducts.map(product => `
                <div class="product-card">
                    <div class="card-header">
                        <h4>${product.name}</h4>
                        <span class="badge badge-${product.isActive ? 'success' : 'secondary'}">
                            ${product.isActive ? 'Activo' : 'Inactivo'}
                        </span>
                    </div>
                    <div class="card-body">
                        <p><strong>SKU:</strong> ${product.sku}</p>
                        <p><strong>Precio:</strong> ${product.price}</p>
                        <p><strong>Stock:</strong> 
                            <span class="stock-indicator ${getStockClass(product)}">
                                ${product.stock}
                            </span>
                        </p>
                        <p><strong>Categor√≠a:</strong> ${getCategoryName(product.category)}</p>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-outline" onclick="editProduct('${product._id}')">Editar</button>
                        <button class="btn btn-danger" onclick="deleteProduct('${product._id}', '${product.name}')">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function updateProductStats() {
            const total = allProducts.length;
            const inStock = allProducts.filter(p => p.stock > p.minStock).length;
            const lowStock = allProducts.filter(p => p.stock <= p.minStock && p.stock > 0).length;
            const outStock = allProducts.filter(p => p.stock === 0).length;

            document.getElementById('totalProducts').textContent = total;
            document.getElementById('inStockProducts').textContent = inStock;
            document.getElementById('lowStockProducts').textContent = lowStock;
            document.getElementById('outStockProducts').textContent = outStock;
        }

        function getCategoryName(categoryId) {
            const category = allCategories.find(c => c._id === categoryId);
            return category ? category.name : categoryId;
        }

        function getStockClass(product) {
            if (product.stock === 0) return 'out-stock';
            if (product.stock <= product.minStock) return 'low-stock';
            return 'in-stock';
        }

        async function saveProduct() {
            try {
                const productData = {
                    name: document.getElementById('productName').value.trim(),
                    description: document.getElementById('productDescription').value.trim(),
                    category: document.getElementById('productCategory').value,
                    brand: document.getElementById('productBrand').value.trim(),
                    sku: document.getElementById('productSku').value.trim(),
                    price: parseFloat(document.getElementById('productPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    minStock: parseInt(document.getElementById('productMinStock').value),
                    featured: document.getElementById('productFeatured').value === 'true',
                    isActive: document.getElementById('productIsActive').value === 'true'
                };

                showSaveProductLoading(true);

                let response;
                if (currentEditingProduct) {
                    // Actualizar producto existente
                    response = await apiRequest(`/products/${currentEditingProduct}`, {
                        method: 'PUT',
                        body: JSON.stringify(productData),
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                } else {
                    // Crear nuevo producto
                    response = await apiRequest('/products', {
                        method: 'POST',
                        body: JSON.stringify(productData),
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                }

                if (response.success) {
                    showToast(currentEditingProduct ? 'Producto actualizado' : 'Producto creado', 'success');
                    closeModal('productModal');
                    await loadProducts();
                } else {
                    throw new Error(response.message || 'Error al guardar producto');
                }

            } catch (error) {
                console.error('Error guardando producto:', error);
                showToast('Error al guardar producto: ' + error.message, 'error');
            } finally {
                showSaveProductLoading(false);
            }
        }

        function editProduct(productId) {
            const product = allProducts.find(p => p._id === productId);
            if (!product) return;

            currentEditingProduct = productId;
            
            document.getElementById('productModalTitle').textContent = 'Editar Producto';
            document.getElementById('productName').value = product.name;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productBrand').value = product.brand || '';
            document.getElementById('productSku').value = product.sku;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productMinStock').value = product.minStock || 5;
            document.getElementById('productFeatured').value = product.featured.toString();
            document.getElementById('productIsActive').value = product.isActive.toString();
            
            openModal('productModal');
        }

        function deleteProduct(productId, productName) {
            document.getElementById('confirmMessage').textContent = 
                `¬øEst√°s seguro de que quieres eliminar el producto "${productName}"?`;
            
            currentDeleteCallback = async () => {
                try {
                    const response = await apiRequest(`/products/${productId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });

                    if (response.success) {
                        showToast('Producto eliminado', 'success');
                        await loadProducts();
                    } else {
                        throw new Error(response.message || 'Error al eliminar producto');
                    }
                } catch (error) {
                    console.error('Error eliminando producto:', error);
                    showToast('Error al eliminar producto: ' + error.message, 'error');
                }
            };
            
            openModal('confirmModal');
        }

        // ================================================
        // FUNCIONES DE DASHBOARD
        // ================================================
        async function updateDashboard() {
            try {
                // Actualizar m√©tricas generales
                document.getElementById('dashTotalUsers').textContent = allUsers.length;
                document.getElementById('dashTotalProducts').textContent = allProducts.length;
                document.getElementById('dashTotalOrders').textContent = '0'; // Placeholder

                // Generar alertas
                generateAlerts();

            } catch (error) {
                console.error('Error actualizando dashboard:', error);
            }
        }

        function generateAlerts() {
            const alertsList = document.getElementById('alertsList');
            const alerts = [];

            // Productos con stock bajo
            const lowStockProducts = allProducts.filter(p => p.stock <= p.minStock && p.stock > 0);
            if (lowStockProducts.length > 0) {
                alerts.push({
                    icon: '‚ö†Ô∏è',
                    message: `${lowStockProducts.length} productos con stock bajo`
                });
            }

            // Productos agotados
            const outStockProducts = allProducts.filter(p => p.stock === 0);
            if (outStockProducts.length > 0) {
                alerts.push({
                    icon: '‚ùå',
                    message: `${outStockProducts.length} productos agotados`
                });
            }

            // Usuarios inactivos
            const inactiveUsers = allUsers.filter(u => !u.isActive);
            if (inactiveUsers.length > 0) {
                alerts.push({
                    icon: 'üë§',
                    message: `${inactiveUsers.length} usuarios inactivos`
                });
            }

            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="alert-item"><span class="alert-icon">‚úÖ</span><span>Todo est√° funcionando correctamente</span></div>';
            } else {
                alertsList.innerHTML = alerts.map(alert => `
                    <div class="alert-item">
                        <span class="alert-icon">${alert.icon}</span>
                        <span>${alert.message}</span>
                    </div>
                `).join('');
            }
        }

        function refreshDashboard() {
            loadInitialData();
        }

        function generateReport() {
            showToast('Funcionalidad de reportes pr√≥ximamente', 'info');
        }

        // ================================================
        // FUNCIONES DE MODAL Y UI
        // ================================================
        function openModal(modalId) {
            if (modalId === 'userModal') {
                currentEditingUser = null;
                document.getElementById('userForm').reset();
                document.getElementById('userModalTitle').textContent = 'Nuevo Usuario';
                document.getElementById('passwordGroup').style.display = 'block';
                document.getElementById('userPassword').required = true;
            } else if (modalId === 'productModal') {
                currentEditingProduct = null;
                document.getElementById('productForm').reset();
                document.getElementById('productModalTitle').textContent = 'Nuevo Producto';
                removeImage();
            }
            
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function confirmDelete() {
            if (currentDeleteCallback) {
                currentDeleteCallback();
                currentDeleteCallback = null;
            }
            closeModal('confirmModal');
        }

        function showSaveUserLoading(show) {
            const text = document.getElementById('saveUserText');
            const spinner = document.getElementById('saveUserSpinner');
            
            if (show) {
                text.style.display = 'none';
                spinner.style.display = 'inline-block';
            } else {
                text.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        function showSaveProductLoading(show) {
            const text = document.getElementById('saveProductText');
            const spinner = document.getElementById('saveProductSpinner');
            
            if (show) {
                text.style.display = 'none';
                spinner.style.display = 'inline-block';
            } else {
                text.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        // ================================================
        // FUNCIONES DE IMAGEN
        // ================================================
        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validar tipo de archivo
            if (!file.type.startsWith('image/')) {
                showToast('Solo se permiten archivos de imagen', 'error');
                return;
            }

            // Validar tama√±o (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('La imagen no debe superar 5MB', 'error');
                return;
            }

            // Mostrar preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                const container = document.getElementById('imagePreviewContainer');
                const info = document.getElementById('imageInfo');
                
                preview.src = e.target.result;
                container.style.display = 'block';
                info.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            const input = document.getElementById('productImageInput');
            const container = document.getElementById('imagePreviewContainer');
            
            input.value = '';
            container.style.display = 'none';
        }

        // ================================================
        // FUNCIONES DE FILTRADO Y B√öSQUEDA
        // ================================================
        function setupEventListeners() {
            // B√∫squeda de usuarios
            document.getElementById('userSearch').addEventListener('input', filterUsers);
            document.getElementById('userRoleFilter').addEventListener('change', filterUsers);
            document.getElementById('userStatusFilter').addEventListener('change', filterUsers);

            // B√∫squeda de productos
            document.getElementById('productSearch').addEventListener('input', filterProducts);
            document.getElementById('productCategoryFilter').addEventListener('change', filterProducts);
            document.getElementById('productStatusFilter').addEventListener('change', filterProducts);
        }

        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const roleFilter = document.getElementById('userRoleFilter').value;
            const statusFilter = document.getElementById('userStatusFilter').value;

            const filteredUsers = allUsers.filter(user => {
                const matchesSearch = user.name.toLowerCase().includes(search) || 
                                    user.email.toLowerCase().includes(search);
                const matchesRole = !roleFilter || user.role === roleFilter;
                const matchesStatus = !statusFilter || user.isActive.toString() === statusFilter;

                return matchesSearch && matchesRole && matchesStatus;
            });

            displayFilteredUsers(filteredUsers);
        }

        function filterProducts() {
            const search = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('productCategoryFilter').value;
            const statusFilter = document.getElementById('productStatusFilter').value;

            const filteredProducts = allProducts.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(search) || 
                                    product.sku.toLowerCase().includes(search) ||
                                    (product.brand && product.brand.toLowerCase().includes(search));
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                const matchesStatus = !statusFilter || product.isActive.toString() === statusFilter;

                return matchesSearch && matchesCategory && matchesStatus;
            });

            displayFilteredProducts(filteredProducts);
        }

        function displayFilteredUsers(users) {
            // Similar a displayUsers pero con array filtrado
            allUsers = users;
            displayUsers();
            allUsers = allUsers; // Restaurar array original
        }

        function displayFilteredProducts(products) {
            // Similar a displayProducts pero con array filtrado
            allProducts = products;
            displayProducts();
            allProducts = allProducts; // Restaurar array original
        }

        // ================================================
        // FUNCIONES DE UTILIDAD
        // ================================================
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        console.log('‚úÖ Panel de administraci√≥n PetStyle cargado');
    </script>

    <!-- 3. Script original del admin (para compatibilidad) -->
      <script src="../js/api.js"></script>
    <script src="/frontend/js/administradores.js"></script>
</body>
</html>