<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - PetStyle</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/login.css">
</head>
<body>
    <!-- Background -->
    <div class="background">
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="logo">
                <i class="fas fa-paw"></i>
                <span>PetStyle</span>
            </div>
            <p class="tagline">Tu tienda de mascotas favorita</p>
        </div>

        <!-- Login Form -->
        <div class="login-form">
            <h2>
                <i class="fas fa-sign-in-alt"></i>
                Iniciar Sesión
            </h2>
            
            <form id="login-form">
                <div class="form-group">
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="email" name="email" placeholder="Email" required autocomplete="email">
                    </div>
                    <div class="field-error" id="email-error"></div>
                </div>
                
                <div class="form-group">
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" name="password" placeholder="Contraseña" required autocomplete="current-password">
                        <button type="button" class="toggle-password" onclick="togglePassword()">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="field-error" id="password-error"></div>
                </div>
                
                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" id="remember-me">
                        <span class="checkmark"></span>
                        Recordarme
                    </label>
                    <a href="#" class="forgot-password" onclick="showForgotPassword()">¿Olvidaste tu contraseña?</a>
                </div>
                
                <button type="submit" class="login-btn" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Iniciar Sesión</span>
                </button>
            </form>
            
            <div class="divider">
                <span>o</span>
            </div>
            
            <div class="alternative-login">
                <button class="social-btn google-btn" onclick="showComingSoon('Google')">
                    <i class="fab fa-google"></i>
                    Continuar con Google
                </button>
                <button class="social-btn facebook-btn" onclick="showComingSoon('Facebook')">
                    <i class="fab fa-facebook-f"></i>
                    Continuar con Facebook
                </button>
            </div>
            
            <div class="register-link">
                <p>¿No tienes una cuenta? <a href="register.html">Regístrate aquí</a></p>
            </div>
            
            <!-- Demo Credentials -->
            <div class="demo-section">
                <h4><i class="fas fa-info-circle"></i> Credenciales de Demo</h4>
                <div class="demo-credentials">
                    <div class="demo-user">
                        <strong>Usuario:</strong> usuario@demo.com
                        <button class="fill-demo" onclick="fillDemoCredentials('usuario@demo.com', '123456')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="demo-user">
                        <strong>Admin:</strong> admin@demo.com
                        <button class="fill-demo" onclick="fillDemoCredentials('admin@demo.com', 'admin123')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Guest Access -->
        <div class="guest-access">
            <button class="guest-btn" id="guest-btn" onclick="loginAsGuest()">
                <i class="fas fa-user"></i>
                Continuar como Invitado
            </button>
            <p class="guest-note">Acceso limitado sin guardar datos</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loading-text">Iniciando sesión...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        // ===== LOGIN PAGE INTEGRATION =====
        console.log('🔐 Login Page Loading...');

        // Check if already logged in
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for auth system to be ready
            if (window.auth && window.auth.initialized) {
                checkExistingSession();
            } else {
                document.addEventListener('authSystemReady', checkExistingSession);
            }
        });

        function checkExistingSession() {
            if (window.auth && window.auth.isLoggedIn()) {
                console.log('User already logged in, redirecting...');
                showToast('Ya tienes una sesión activa', 'info');
                
                setTimeout(() => {
                    if (auth.isAdmin()) {
                        window.location.href = 'admin.html';
                    } else {
                        window.location.href = 'main.html';
                    }
                }, 1000);
            }
        }

        // Form submission handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            // Clear previous errors
            clearFieldErrors();
            
            // Basic validation
            if (!email) {
                showFieldError('email', 'El email es obligatorio');
                return;
            }
            
            if (!password) {
                showFieldError('password', 'La contraseña es obligatoria');
                return;
            }
            
            if (!isValidEmail(email)) {
                showFieldError('email', 'Email no válido');
                return;
            }
            
            // Show loading
            showLoading('Iniciando sesión...');
            
            try {
                // Use the auth system
                const result = await auth.login(email, password);
                
                if (result.success) {
                    showToast('Inicio de sesión exitoso', 'success');
                    console.log('Login successful, auth will handle redirect');
                } else {
                    throw new Error(result.message || 'Error en el inicio de sesión');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                hideLoading();
                showToast(error.message || 'Error al iniciar sesión', 'error');
            }
        });

        // Guest login
        async function loginAsGuest() {
            showLoading('Configurando acceso como invitado...');
            
            try {
                // Create guest user
                const guestUser = {
                    id: 'guest_' + Date.now(),
                    name: 'Invitado',
                    email: 'guest@petstyle.local',
                    role: 'guest',
                    isGuest: true
                };
                
                // Save guest session
                auth.currentUser = guestUser;
                auth.saveSession();
                
                showToast('Acceso como invitado configurado', 'success');
                
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1000);
                
            } catch (error) {
                console.error('Guest login error:', error);
                hideLoading();
                showToast('Error al configurar acceso como invitado', 'error');
            }
        }

        // Demo credentials
        function fillDemoCredentials(email, password) {
            document.getElementById('email').value = email;
            document.getElementById('password').value = password;
            showToast('Credenciales de demo rellenadas', 'info');
        }

        // Password toggle
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.querySelector('.toggle-password i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.classList.remove('fa-eye');
                toggleBtn.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleBtn.classList.remove('fa-eye-slash');
                toggleBtn.classList.add('fa-eye');
            }
        }

        // Forgot password
        function showForgotPassword() {
            showToast('Funcionalidad en desarrollo. Contacta al administrador.', 'info');
        }

        // Social login placeholders
        function showComingSoon(provider) {
            showToast(`Inicio de sesión con ${provider} próximamente`, 'info');
        }

        // Utility functions
        function showLoading(message = 'Cargando...') {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showToast(message, type = 'info') {
            // Use global toast system if available
            if (window.utils && window.utils.notifications) {
                window.utils.notifications[type](message);
                return;
            }
            
            // Fallback toast implementation
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'ℹ️'}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        function showFieldError(fieldId, message) {
            const errorElement = document.getElementById(`${fieldId}-error`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.add('error');
            }
        }

        function clearFieldErrors() {
            document.querySelectorAll('.field-error').forEach(error => {
                error.textContent = '';
                error.style.display = 'none';
            });
            
            document.querySelectorAll('.form-input, input').forEach(input => {
                input.classList.remove('error');
            });
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Real-time validation
        document.getElementById('email').addEventListener('input', function() {
            if (this.value && !isValidEmail(this.value)) {
                showFieldError('email', 'Email no válido');
            } else {
                document.getElementById('email-error').style.display = 'none';
                this.classList.remove('error');
            }
        });

        document.getElementById('password').addEventListener('input', function() {
            if (this.value) {
                document.getElementById('password-error').style.display = 'none';
                this.classList.remove('error');
            }
        });

        // Handle Enter key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.target.closest('form')) {
                e.preventDefault();
                document.getElementById('login-form').dispatchEvent(new Event('submit'));
            }
        });

        console.log('✅ Login Page Ready');
    </script>

     

</body>
</html>